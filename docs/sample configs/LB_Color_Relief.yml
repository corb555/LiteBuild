# ===================================================================
# LiteBuild Configuration  to create a color relief hillshade raster using GDAL tools
# 
# creates a DEM image from multiple USGS files
# creates a gdaldem hill-shade
# creates an arid layer 
# creates a humid layer 
# merges them using a precipitation mask 
# publishes the result to a Tile Server
# 
# Supports multiple targets (US, Washington, etc) each with their own settings.
# ===================================================================
config_type: "LiteBuild"

DEFAULT_WORKFLOW_STEP: PublishPMTiles

# ===  GLOBAL PARAMETERS  ===
GENERAL:
  PROJECT_NAME: "US"
  PREVIEW: ""
  INPUT_DIRECTORY: "elevation/"
  BUILD_DIR: build/{profile_name}
  QUIET: -q
  PUBLISH_DIRECTORY: /Volumes/Mike EXT/Tile_Data/Mapnik/img

  # Default parameters for rules
  PARAMETERS:
    align_raster:
      co:
        - "COMPRESS=ZSTD"

    scale_precip_mask:
      scale: 200 600

    create_humid_color_ramp:
      min-hue: 0
      max-hue: 0
      target-hue: 0
      saturation: 1.0
      shadow-adjust: 0.0
      mid-adjust: 0.0
      highlight-adjust: 0.0

    create_arid_color_ramp:
      min-hue: 35
      max-hue: 140
      target-hue: 34
      saturation: 0.6
      shadow-adjust: 0.2
      mid-adjust: 0.2
      highlight-adjust: 0

    create_vrt:
      resolution: highest
      vrtnodata: -9999

    create_dem:
      r: cubicspline
      co:
        - "COMPRESS=ZSTD"
      t_srs: epsg:3857

    create_dem_preview:
      size: 4000
      x-anchor: 0.5
      y-anchor: 0.5

    create_hillshade:
      co:
        - "COMPRESS=JPEG"
        - "JPEG_QUALITY=85"
      compute_edges: true

    create_color_layer:
      co:
        - "COMPRESS=JPEG"
        - "JPEG_QUALITY=85"
      compute_edges: true

    merge_layers:
      co:
        - "COMPRESS=JPEG"
        - "JPEG_QUALITY=85"

    publish:
      disable: false
      host:

    vignette:
      border: 5 
      noise: 20
      warp: 60     

# ===  PROFILES ===
# Each profile lists the required USGS DEM files and may also tweak color settings
PROFILES:
  Yellowstone_1m:
    INPUT_FILES:
      - USGS_1M_12_x51y493_WY_YellowstoneNP_2020_D20.tif
      - USGS_1M_12_x51y494_WY_YellowstoneNP_2020_D20.tif
    PARAMETERS:
      create_hillshade:
        "z": 3
        "igor": true
      create_humid_color_ramp:
        min-hue: 0
        max-hue: 111
        target-hue: 35
        saturation: 0.6
        shadow-adjust: 0.2
        mid-adjust: 0.3
        highlight-adjust: 0.0

  GrandCanyon:
    INPUT_FILES:
      - USGS_13_n36w112_20240614.tif
      - USGS_13_n37w112_20240614.tif
      - USGS_13_n36w113_20240614.tif
      - USGS_13_n37w113_20240614.tif
    PARAMETERS:
      create_hillshade:
        "z": 3
        "igor": true
      create_humid_color_ramp:
        min-hue: 80
        max-hue: 166
        target-hue: 28
        saturation: 0.8
        shadow-adjust: 0.0
        mid-adjust: 0.0
        highlight-adjust: 0.0
      create_dem:
        te: -12576928 4280734 -12413222 4412480

  Yellowstone:
    INPUT_FILES:
      - USGS_13_n45w111_20250122.tif
    PARAMETERS:
      create_dem:
        te: -12340984.5 5535300.2 -12335654.5 5549090.8
      create_hillshade:
        "z": 3
        "igor": true

  USWest:
    INPUT_FILES:
      - 10n090w_20101117_gmted_mea075.tif
      - 10n120w_20101117_gmted_mea075.tif
      - 30n090w_20101117_gmted_mea075.tif
      - 30n120w_20101117_gmted_mea075.tif
      - 30n150w_20101117_gmted_mea075.tif
      - 50n090w_20101117_gmted_mea075.tif
      - 50n120w_20101117_gmted_mea075.tif
      - 50n150w_20101117_gmted_mea075.tif
    PARAMETERS:
      create_dem: 
        te: -14077656 2835222.9 -9710737.7 6435460.8
      create_hillshade:
        "z": 3
        "igor": true
      vignette:
        border: 0 
        noise: 0
        warp: 0

# ===  WORKFLOW ===
WORKFLOW:
  VRTFile:
    REQUIRES: [ ]
    OUTPUT: "{BUILD_DIR}/{profile_name}.vrt"
    RULE:
      NAME: "create_vrt"
      INPUT_STYLE: "positional"
      INPUT_QUOTED: false # Specific override for gdalbuildvrt
      COMMAND: |
        mkdir -p $(dirname {OUTPUT}) && \
        gdalbuildvrt -strict -overwrite {PARAMETERS} {OUTPUT} {INPUTS}
    INPUTS: "{INPUT_FILES}"

  DEMFile:
    REQUIRES: [VRTFile]
    OUTPUT: "{BUILD_DIR}/{profile_name}_DEM.tif"
    RULE:
      NAME: "create_dem"
      COMMAND: gdalwarp {INPUTS[0]} {OUTPUT} {PARAMETERS}  -wo INIT_DEST=NO_DATA  -overwrite -multi -dstnodata -9999 -dstalpha --config GDAL_CACHEMAX 30%
      UNQUOTED_PARAMS: ["te","tr"]
    INPUTS: ["{REQUIRES[0]}"]

  ValidateDEM:
    REQUIRES: ["DEMFile"]
    OUTPUT: "{BUILD_DIR}/{profile_name}_DEM.validated" # Dummy file or just empty
    RULE:
      NAME: "validate_raster"
      # validates TIF size is reasonable
      COMMAND: "gdal-helper validate_raster {INPUTS[0]} --min-bytes 50000 --min-pixels 100000 && touch {OUTPUT}"
    INPUTS: ["{REQUIRES[0]}"]

  DEMPreviewFile:
    REQUIRES: [ "DEMFile" ]
    OUTPUT: "{BUILD_DIR}/{profile_name}_DEM_prv.tif"
    RULE:
      NAME: "create_dem_preview"
      COMMAND: "gdal-helper create_subset {POSITIONAL_FILENAMES} {OUTPUT} {PARAMETERS}"
      DASH: "--"
    POSITIONAL_FILENAMES:
      - "{INPUTS[0]}"
    INPUTS: [ "{REQUIRES[0]}" ]

  HillshadeLayer:
    REQUIRES:
      - "ValidateDEM"
      - "DEMPreviewFile"
      - "DEMFile"
    OUTPUT: "{BUILD_DIR}/{profile_name}_hillshade{PREVIEW}.tif"
    RULE:
      NAME: "create_hillshade"
      COMMAND: "gdaldem hillshade {INPUTS[0]} {OUTPUT} {PARAMETERS}"
    INPUTS:
      - "{BUILD_DIR}/{profile_name}_DEM{PREVIEW}.tif"

  AlignPrecipMask:
    REQUIRES: ["DEMFile"]
    OUTPUT: "{BUILD_DIR}/{profile_name}_mask_tmp.tif"
    POSITIONAL_FILENAMES:
      - "{INPUTS[0]}"
      - "{INPUTS[1]}"
    INPUTS:
      - "{INPUT_DIRECTORY}{PROJECT_NAME}_raw_precip.tif"
      - "{REQUIRES[0]}"
    RULE:
      NAME: "align_raster"
      COMMAND: "gdal-helper align_raster {POSITIONAL_FILENAMES} {OUTPUT} {PARAMETERS}"
      DASH: "--"

  ScalePrecipMask:
    REQUIRES: [ "AlignPrecipMask" ]
    OUTPUT: "{BUILD_DIR}/{profile_name}_precip_mask.tif"
    RULE:
      NAME: "scale_precip_mask"
      COMMAND: "gdal_translate -ot Byte -exponent 1 {PARAMETERS} {INPUTS[0]} {OUTPUT} "
      UNQUOTED_PARAMS: [ "scale" ]
    INPUTS: [ "{REQUIRES[0]}" ]

  HumidColorRamp:
    REQUIRES: [ ]
    OUTPUT: "{BUILD_DIR}/{profile_name}_humid_color_ramp.txt"
    RULE:
      NAME: "create_humid_color_ramp"
      COMMAND: "gdal-helper adjust_color_file {INPUTS[0]} {OUTPUT} {PARAMETERS}"
      DASH: "--"
    INPUTS:
      - "{PROJECT_NAME}_color_ramp.txt"

  AridColorRamp:
    REQUIRES: [ ]
    OUTPUT: "{BUILD_DIR}/{profile_name}_arid_color_ramp.txt"
    RULE:
      NAME: "create_arid_color_ramp"
      COMMAND: "gdal-helper adjust_color_file {INPUTS[0]} {OUTPUT} {PARAMETERS}"
      DASH: "--"
    INPUTS:
      - "{PROJECT_NAME}_color_ramp.txt"

  HumidColorLayer:
    REQUIRES:
      - "DEMFile"
      - "HumidColorRamp"
    OUTPUT: "{BUILD_DIR}/{profile_name}_humid_color.tif"
    RULE:
      NAME: "create_color_layer"
      COMMAND: "gdaldem color-relief {INPUTS[0]} {INPUTS[1]} {OUTPUT} {PARAMETERS}"
    INPUTS:
      - "{REQUIRES[0]}"
      - "{REQUIRES[1]}"

  AridColorLayer:
    REQUIRES:
      - "DEMFile"
      - "AridColorRamp"
    OUTPUT: "{BUILD_DIR}/{profile_name}_arid_color.tif"
    RULE:
      NAME: "create_color_layer"
      COMMAND: "gdaldem color-relief {INPUTS[0]} {INPUTS[1]} {OUTPUT} {PARAMETERS}"
    INPUTS:
      - "{REQUIRES[0]}"
      - "{REQUIRES[1]}"

  AridHumidBlend:
    REQUIRES:
      - "ScalePrecipMask"
      - "HumidColorLayer"
      - "AridColorLayer"
    OUTPUT: "{BUILD_DIR}/{profile_name}_blended{PREVIEW}.tif"
    RULE:
      NAME: "masked_blend"
      COMMAND: "gdal-helper masked_blend {POSITIONAL_FILENAMES} {OUTPUT} {PARAMETERS}"
      DASH: "--"
    INPUTS:
      - "{REQUIRES[0]}"
      - "{REQUIRES[1]}"
      - "{REQUIRES[2]}"
    POSITIONAL_FILENAMES:
      - "{INPUTS[1]}"
      - "{INPUTS[2]}"
      - "{INPUTS[0]}"

  HillshadeBlend:
    REQUIRES:
      - "HillshadeLayer"
      - "AridHumidBlend"
    OUTPUT: "{BUILD_DIR}/{profile_name}_relief_raw.tif" # Changed name to indicate it's intermediate
    RULE:
      NAME: "merge_layers"
      DASH: "--"
      COMMAND: "gdal-helper hillshade_blend {POSITIONAL_FILENAMES} {OUTPUT} {PARAMETERS}"
    INPUTS:
      - "{REQUIRES[0]}"
      - "{REQUIRES[1]}"
    POSITIONAL_FILENAMES:
      - "{INPUTS[0]}"
      - "{INPUTS[1]}"

  VignetteLayer:
    REQUIRES:
      - "HillshadeBlend"
    OUTPUT: "{BUILD_DIR}/{profile_name}_relief{PREVIEW}.tif"
    RULE:
      NAME: "vignette" 
      COMMAND: "gdal-helper vignette {INPUTS[0]} {OUTPUT} {PARAMETERS}"
      DASH: "--"
    INPUTS:
      - "{REQUIRES[0]}"

  CreateMBTiles:
    REQUIRES:
      - "VignetteLayer" 
    OUTPUT: "{BUILD_DIR}/{profile_name}_relief{PREVIEW}.mbtiles"
    RULE:
      NAME: "create_mbtiles"
      COMMAND: "gdal-helper create_mbtiles {INPUTS[0]} {OUTPUT} --format PNG"
    INPUTS:
      - "{REQUIRES[0]}"

  CreatePMTiles:
    REQUIRES:
      - "CreateMBTiles"
    OUTPUT: "{BUILD_DIR}/{profile_name}_relief{PREVIEW}.pmtiles"
    RULE:
      NAME: "create_pmtiles"
      COMMAND: "gdal-helper create_pmtiles {INPUTS[0]} {OUTPUT}"
    INPUTS:
      - "{REQUIRES[0]}"
  
  PublishTif:
    REQUIRES:
      - "VignetteLayer" 
    OUTPUT: "{BUILD_DIR}/{profile_name}_tif_publish.marker"
    RULE:
      NAME: "publish"
      COMMAND: "gdal-helper publish {POSITIONAL_FILENAMES} --marker-file {OUTPUT} {PARAMETERS}"
      DASH: "--"
    POSITIONAL_FILENAMES:
      - "{INPUTS[0]}"
      - "{PUBLISH_DIRECTORY}"
    INPUTS:
      - "{REQUIRES[0]}"

  PublishPMTiles:
    REQUIRES:
      - "CreatePMTiles"
    OUTPUT: "{BUILD_DIR}/{profile_name}_pmtiles_publish.marker"
    RULE:
      NAME: "publish"
      COMMAND: "gdal-helper publish {POSITIONAL_FILENAMES} --marker-file {OUTPUT} {PARAMETERS}"
      DASH: "--"
    POSITIONAL_FILENAMES:
      - "{INPUTS[0]}"
      - "{PUBLISH_DIRECTORY}"
    INPUTS:
      - "{REQUIRES[0]}"